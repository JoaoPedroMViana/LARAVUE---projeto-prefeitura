<script setup>
    import { Head, Link, router, usePage } from '@inertiajs/vue3';
    import { ref, watch } from 'vue';
    import MainLayout from "../Layouts/MainLayout.vue";
    import { toast } from 'vue3-toastify';
    import 'vue3-toastify/dist/index.css';

    const props = defineProps({
        protocolos: Object
    });

    const page = usePage();

    // Modal excluir
    let dialog = ref(false)
    let protocolo_excluir = ref({
        numero: null,
        pessoa_nome: null
    })

    const deletarProtocolo = (numero) => {
        router.delete(`/protocolo/delete/${numero}`, {onSuccess: () => {
            if(page.props.flash){
                toast(`${page.props.flash}`, {
                    "autoClose": 2500,
                    "type": "success",
                    "dangerouslyHTMLString": true,
                    "position": "top-center",
                });// Mensagem de sucesso
            }
        }});
    }

    // Formatar data tabela
    const formatarData = (date) => {
        const dataString = date;
        const [ano, mes, dia] = dataString.split('-');
        let formatada = `${dia}/${mes}/${ano}`
        return formatada;
    }

    // página de editar
    const editar = (numero) => {
        router.get(`/protocolo/${numero}`);
    }

    // páginação
    let pagina_atual = ref(props.protocolos.current_page);
    let itens_por_pag = ref(props.protocolos.per_page)

    watch(pagina_atual, () => {
        router.get(`/protocolos?page=${pagina_atual.value}&itens_pag=${itens_por_pag.value}`)
    })

    watch(itens_por_pag, () => {
        let ultima_pagina = Math.ceil(parseInt(props.protocolos.total) / itens_por_pag.value);
        // calcula a última página disponivel com base no total de protocolos e os itens por página
        if(ultima_pagina < pagina_atual.value){
            pagina_atual.value = ultima_pagina;
            // verifica se a ultima pagina disponivel é menor que a página atual
        }
        router.get(`/protocolos?page=${pagina_atual.value}&itens_pag=${itens_por_pag.value}`)
    })

</script>

<template>
    <div>
        <Head title="Protocolos" />
        <main-layout paginaAtual="Protocolos" class="w-full">
            <v-dialog
            v-model="dialog"
            transition="dialog-top-transition"
            class="w-50"
            >   
                <v-card
                    rounded="lg"
                >
                    <v-card-title class="pt-6">
                        <p class="text-2xl p-2 pb-0"><v-icon icon="mdi-delete-circle"></v-icon> Deletar protocolo {{protocolo_excluir.numero}}</p>    
                    </v-card-title>
                    <v-card-text class="pl-8 pt-2">Deseja excluir o protocolo vinculado a pessoa: <b class="text-red-800 underline">{{protocolo_excluir.pessoa_nome}}</b>?</v-card-text>
                    <template v-slot:actions>
                    <v-container class="flex justify-end gap-4">
                        <v-btn
                            class="px-5" size="large" rounded="lg" color="#B71C1C" variant="flat"
                            @click="dialog = false;  deletarProtocolo(protocolo_excluir.numero)"
                        >
                            Deletar
                        </v-btn>

                        <v-btn
                            class="px-5" size="large" rounded="lg" color="#0D47A1" variant="tonal"
                            @click="dialog = false"
                        >
                            Cancelar
                        </v-btn>
                    </v-container>
                    </template>
                </v-card>
            </v-dialog>
            <v-app class="w-full my-3">
                <div class="w-full flex justify-center">
                    <v-card elevation="4" class="w-5/6 rounded-lg">
                        <div class="w-100 flex items-center justify-between m-0 py-2">
                            <p class="text-sm py-0 my-0 ml-8 opacity-45">Total de protocolos: {{protocolos.total}}</p> 
                            <v-btn class="mr-8" rounded="lg" variant="text">
                                <Link href="/protocolos/cadastro" ><v-icon icon="mdi-plus-circle-outline" class="mr-3"></v-icon> Cadastrar</Link>
                            </v-btn>
                        </div>
                        <v-table  density="comfortable" hover class="p-5 pt-0">
                            <thead class="text-base">
                                <tr>
                                    <th>Número</th>
                                    <th>Descrição</th>
                                    <th>Data de registro</th>
                                    <th>Prazo</th>
                                    <th>Contruibuinte</th>
                                </tr>
                            </thead>
                            <tbody v-if="protocolos.data.lenght != 0">
                                <tr v-for="protocolo in protocolos.data" :key="protocolo.numero">
                                    
                                    <td>{{protocolo.numero}}</td>
                                    <td>{{protocolo.descricao}}</td>
                                    <td>{{formatarData(protocolo.data_registro)}}</td>
                                    <td>{{protocolo.prazo}}</td>
                                    <td><Link class="hover:underline text-blue-500" :href="`/pessoas/pesquisar?nome=${protocolo.pessoa.nome}`">{{protocolo.pessoa.nome}}</Link></td> 
                                    <td>
                                        <v-btn class="mr-6 h-75" rounded="lg" color="#7CB342" prepend-icon="mdi-pencil" variant="flat" @click.once="editar(protocolo.numero)">
                                            Editar 
                                        </v-btn>
                                        <v-btn class="h-75" rounded="lg" color="#B71C1C" prepend-icon="mdi-delete-outline" variant="flat" @click="dialog = true; protocolo_excluir.numero = protocolo.numero; protocolo_excluir.pessoa_nome = protocolo.pessoa.nome">
                                            Apagar  
                                        </v-btn>
                                    </td>
                                </tr>
                            </tbody>     
                        </v-table>
                        <p v-if="protocolos.data.length == 0" ><v-icon icon="mdi-alert-circle" class="ml-6 m-4"></v-icon> Nenhum protocolo encontrado"</p>
                        <div class="flex w-100 justify-center relative">
                            <div v-if="protocolos.data.length != 0"  class="w-40 absolute left-8 flex gap-4 items-center justify-center">    
                                <v-select
                                    v-model="itens_por_pag"
                                    variant="outlined"
                                    rounded="md"
                                    density="comfortable"
                                    :items="[protocolos.total, '20', '10', '5']"
                                    base-color="#7CB342"
                                    label="Itens por página"
                                    color="#7CB342"
                                ></v-select>
                                {{itens}}
                            </div>
                            <v-pagination
                                v-if="protocolos.data.length != 0" 
                                v-model="pagina_atual"
                                :length="protocolos.last_page"
                                class="mb-2"
                                :total-visible="5"
                                active-color="#1B5E20"
                                color="#7CB342"
                                rounded
                            ></v-pagination>
                        </div>
                    </v-card>    
                </div>    
            </v-app>
        </main-layout>
    </div>
</template>

<style scoped>
    [type='text']:focus {
        box-shadow: none; 
        /* por algum motivo os inputs tavam com um box-shadow azul no focus  que parecia um border */
    }
</style>